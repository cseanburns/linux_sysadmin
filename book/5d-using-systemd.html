<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Using systemd - Linux Systems Administration</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Entry level book on Linux systems administration.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Linux Systems Administration</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/cseanburns/linux_sysadmin" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="using-systemd"><a class="header" href="#using-systemd">Using systemd</a></h1>
<p>By the end of the section, you will know how to:</p>
<ol>
<li>Use <code>systemctl</code> to manage services on a Linux system,
including starting, stopping, enabling, and checking the status of services.</li>
<li>Understand the purpose of <code>systemd</code> as an init system and its role in booting, service management, and log handling.</li>
<li>Check the status and logs of specific services with <code>journalctl</code> and
use filters to narrow down log results by service, PID, or specific conditions.</li>
<li>Set up and manage <code>systemd</code> timers to automate tasks, such as scheduling scripts to run at specific times.</li>
<li>Explore and utilize additional <code>systemd</code> commands,
such as checking enabled services, suspending or rebooting the system, and examining boot times with <code>systemd-analyze</code>.</li>
<li>View and interpret system logs, search through them efficiently, and follow logs in real-time.</li>
<li>Create and configure custom <code>systemd</code> service and timer files for more tailored system automation.</li>
<li>Use <code>systemd</code> commands to troubleshoot system issues,
including identifying failed services and examining resource usage with <code>systemd-cgtop</code>.</li>
</ol>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h2>
<p>When computers boot up, obviously some software manages that process.
On Linux and other Unix or Unix-like systems, this is usually handled via an <strong>init</strong> system.
For example, macOS uses <a href="https://en.wikipedia.org/wiki/Launchd">launchd</a> and many Linux distributions, including Ubuntu, use <a href="https://en.wikipedia.org/wiki/Systemd">systemd</a>.</p>
<p><strong>systemd</strong> does more than handle the startup process,
it also manages various services and connects the Linux kernel to various applications.
In this section, we'll cover how to use <strong>systemd</strong> to manage services and to review log files.</p>
<h2 id="manage-services"><a class="header" href="#manage-services">Manage Services</a></h2>
<p>When we install complicated software, like a web server (e.g., Apache2, Nginx), a SSH server (e.g., OpenSSH),
or a database server (e.g., mariaDB or MySQL), then it's helpful to have commands that manage that service:
the web service, the SSH service, the database service, etc.</p>
<p>For example, the <code>ssh</code> service is installed by default on our gcloud servers, and
we can check its status with the following <code>systemctl</code> command:</p>
<pre><code>systemctl status ssh
</code></pre>
<p>The output tells us a few things.
The line beginning with <code>Loaded</code> tells us that the SSH service is configured.
At the end of that line, it also tells us that it is <code>enabled</code>.
<code>Enabled</code> means that the service automatically starts when the system gets rebooted or starts up.</p>
<p>The line beginning with <code>Active</code> tells us that the service is <code>active (running)</code> and for how long.
We also can see the process ID (PID) for the service as well as how much memory it's using.</p>
<p>At the bottom of the output, we can see the recent log files.
We can view more of those log files using the <code>journalctl</code> command.
By default, running <code>journalctl</code> by itself will return all log files.
We can specify that we're interested in log files only for the ssh service.
We can specify using the PID number.
Replace <em>N</em> with the PID number attached to your ssh service:</p>
<pre><code>journalctl _PID=N
</code></pre>
<p>Or we can specify by service, or more specifically, its <strong>unit</strong> name:</p>
<pre><code>journalctl -u ssh
</code></pre>
<h3 id="use-cases"><a class="header" href="#use-cases">Use Cases</a></h3>
<p>Later we'll install the <a href="https://httpd.apache.org/">Apache web server</a>, and we will use <code>systemctl</code> to manage some aspects of this service.</p>
<p>In particular, we will use the following commands to:</p>
<ol>
<li>Check the state of the Apache service,</li>
<li>enable the Apache service to auto start on reboot,</li>
<li>start the service,</li>
<li>reload the service after editing its configuration files, and</li>
<li>stop the service.</li>
</ol>
<p>In practice, these work out to:</p>
<pre><code>systemctl status apache2
sudo systemctl enable apache2
sudo systemctl start apache2
sudo systemctl reload apache2
sudo systemctl stop apache2
</code></pre>
<p><code>systemctl</code> is a big piece of software, and there are other arguments the command will take.
See <code>man systemctl</code> for details.</p>
<p><strong>NOTE:</strong> Not all services support <code>systemctl reload [SERVICE]</code>.
You can check if a service is reloadable by checking its service file.
As an example:</p>
<pre><code>grep "ExecReload" /lib/systemd/system/ssh.service
</code></pre>
<p>You can peruse other services in <code>/lib/systemd/system</code>.</p>
<h2 id="examine-logs"><a class="header" href="#examine-logs">Examine Logs</a></h2>
<p>As mentioned, the <code>journalctl</code> command is part of the <code>systemd</code> software suite, and it is used to monitor system logs.</p>
<p>It's important to monitor system logs.
Log files help identify problems in the system or with various services.
For example, by monitoring the log entries for <strong>ssh</strong>, I can see all the attempts to break into the server.
Or if the Apache2 web server malfunctions for some reason, which might be because of a configuration error,
the logs will indicated how to identify the problem.</p>
<p>If we type <code>journalctl</code> at the command prompt, we are be presented with the logs for the entire system.
These logs can be paged through by pressing the space bar, the page up/page down keys, or the up/down arrow keys.
They can also be searched by pressing the forward slash <code>/</code> and then entering a search keyword.
To exit out of the pager, press <strong>q</strong> to quit.</p>
<pre><code>journalctl
</code></pre>
<p>It's much more useful to specify the field and to declare an option when using <code>journalctl</code>, like above with <code>ssh</code>
See the following man pages for details:</p>
<pre><code>man systemd.journal-fields
man journalctl
</code></pre>
<p>There are many fields and options we can use, but as an example,
we see that there is an option to view the more recent entries first:</p>
<pre><code>journalctl -r
</code></pre>
<p>Or we view log entries in reverse order, for users on the system, and since the last boot with the following options:</p>
<pre><code>journalctl -r --user -b 0
</code></pre>
<p>Or for the system:</p>
<pre><code>journalctl -r --system -b 0
</code></pre>
<p>I can more specifically look at the logs files for a service by using the <code>-u</code> option with <code>journalctl</code>:</p>
<pre><code>journalctl -u apache2
</code></pre>
<p>I can follow the logs in real-time (press <strong>ctrl-c</strong> to quit the real-time view):</p>
<pre><code>journalctl -f
</code></pre>
<h2 id="timers-automation"><a class="header" href="#timers-automation">Timers (Automation)</a></h2>
<p>Linux and Unix operating systems have long provided a way to automate processes.
Historically, the <code>cron</code> service has been used to automate jobs, but I do not cover it here.
Instead, we examine how to use <code>systemd</code> as a way to automate jobs using <strong>timers</strong>.</p>
<p>The <code>/var/log/auth.log</code> file logs all authentication attempts to the system.
We can create a script to look at the file and extract the invalid attempts to login to the system.</p>
<p>What if we could have that script run at specific times?
For example, what if we wanted to run that script every morning at 8AM and then log the output to a file for us to read?
We can do that with systemd timers.</p>
<p>First, let's create a very simple <code>auth.sh</code> script to do this job.
In the example below, I've set the location of the <code>auth.log</code> file and the output file,
added a check to be sure the file exists and/or can be read,
created two additional variables to record the start and end dates of the auth.log file, and
used <code>grep</code> again to look for invalid IP addresses in the log file,
wrote an <code>echo</code> statement to add some additional information, and
save the output in a file called <code>brute.log</code> in our <code>$HOME</code> directory.
The <code>${end_date}</code> and <code>${start_date}</code> variables were created after closely studying the <code>/var/log/auth.log</code> file.
This is a very basic file, and programming languages like <code>awk</code>, <code>perl</code>, or <code>python</code> might be better suited for this job,
but for <code>bash</code> sake:</p>
<pre><code>#!/usr/bin/env bash

LOG_FILE="${1:-/var/log/auth.log}"
OUT_FILE="${HOME}/brute.log"

if [[ ! -r "${LOG_FILE}" ]] ; then
    echo "Error: cannot read '${LOG_FILE}' (permission or file missing)." &gt;&amp;2
    echo "Try running with sudo or pass a readable log path." &gt;&amp;2
    exit 2
fi

END_DATE=$(grep -Eo "^[[:alpha:]]{3}[[:space:]]{1,2}[[:digit:]]{1,2}" "${LOG_FILE}" | tail -n1)
START_DATE=$(grep -Eo "^[[:alpha:]]{3}[[:space:]]{1,2}[[:digit:]]{1,2}" "${LOG_FILE}" | head -n1)

TOTAL_INVALID="$(grep -c "Invalid user" "${LOG_FILE}")"
INVALID_IPS="$(grep "Invalid user" "${LOG_FILE}" | \
    grep -Eo "[[:digit:]]+\.[[:digit:]]+\.[[:digit:]]+\.[[:digit:]]+" | \
    sort | uniq | wc -l)"

echo "
Log entry created on $(date +%c).
From ${START_DATE} to ${END_DATE}, there were ${TOTAL_INVALID} attempts to login to the system.
These came from ${INVALID_IPS} unique IPs.
" &gt;&gt; "${OUT_FILE}"

</code></pre>
<p>Next, to automate the execution of this script, we need to create two additional files.
First we create a <strong>service</strong> file.
This file defines the <strong>service</strong> that we want to execute.
Navigate to the systemd's service directory:</p>
<pre><code>cd /etc/systemd/system
</code></pre>
<p>And use <code>sudo nano</code> to create a file called <code>brute.service</code>:</p>
<pre><code>sudo nano brute.service
</code></pre>
<p>In the above file, we add the following information under two sections, a Unit section and a Service section.
The Unit section includes a description of the service and a list of the service's requirements.
The Service section declares the type of service, the location of the script to run, and the user to run the script under.
Feel free to use this but be sure to change your User information:</p>
<pre><code>[Unit]
Description="Summarize brute login attempts."
Requires=brute.timer

[Service]
Type=simple
ExecStart=/usr/local/bin/auth.sh
User=seanburns
</code></pre>
<p>See <code>man 5 systemd.service</code> for more details.</p>
<p>Next we need to create the <strong>timer</strong> file.
Using <code>sudo nano</code>, run the following command in the same directory as above:</p>
<pre><code>sudo nano brute.timer
</code></pre>
<p>In this file, add the following:</p>
<pre><code>[Unit]
Description="Timer for the brute login service."

[Timer]
OnCalendar=*-*-* 08:00:00
Persistent=true

[Install]
WantedBy=timers.target
</code></pre>
<p>See <code>man 5 systemd.timer</code> for more details.</p>
<p>Next we need to enable and start the timer.
To do that, we run two separate <code>systemctl</code> commands:</p>
<pre><code>sudo systemctl daemon-reload
</code></pre>
<p>And then enable the timer:</p>
<pre><code>sudo systemctl enable brute.timer
</code></pre>
<p>Start the timer:</p>
<pre><code>sudo systemctl start brute.timer
</code></pre>
<p>And finally, check the status of all timers:</p>
<pre><code>systemctl list-timers
</code></pre>
<p>Or check the status of our specific timer:</p>
<pre><code>systemctl status brute.timer
</code></pre>
<p>You can now check that your script ran after the next time your system's clock reaches 8AM.</p>
<h2 id="useful-systemd-commands"><a class="header" href="#useful-systemd-commands">Useful Systemd Commands</a></h2>
<p>You can see more of what <code>systemctl</code> or <code>journalctl</code> can do by reading through their documentation:</p>
<pre><code>man systemctl
man journalctl
</code></pre>
<p>You can check if a service if enabled:</p>
<pre><code>systemctl is-enabled apache2
</code></pre>
<p>You can reboot, poweroff, or suspend a system (suspending a system mostly makes sense for laptops and not servers):</p>
<pre><code>systemctl reboot
systemctl poweroff
systemctl suspend
</code></pre>
<p>To show configuration file changes to the system:</p>
<pre><code>systemd-delta
</code></pre>
<p>To list real-time control group process, resource usage, and memory usage:</p>
<pre><code>systemd-cgtop
</code></pre>
<ul>
<li>to search failed processes/services:</li>
</ul>
<pre><code>systemctl --state failed
</code></pre>
<ul>
<li>to list services</li>
</ul>
<pre><code>systemctl list-unit-files -t service
</code></pre>
<ul>
<li>to examine boot time:</li>
</ul>
<pre><code>systemd-analyze
</code></pre>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>This is a basic introduction to <strong>systemd</strong>, which is composed of a suite of software to help manage booting a system,
managing services, and monitoring logs.</p>
<p>We'll put what we've learned into practice when we set up our LAMP servers.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="5c-managing-software.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="p6-networking-security.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="5c-managing-software.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="p6-networking-security.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
